#!/bin/bash
function setupPackages() {
    echo "$(date) updating apt repository and installing packages";
    apt update && apt install gcc gcc-multilib mingw-w64 git net-tools zip gzip python3 nasm gdb -y;

    echo "$(date) setting up gdb peda";
    git clone https://github.com/longld/peda.git ~/peda
    echo "source ~/peda/peda.py" >> ~/.gdbinit

    echo "$(date) setting up boofuzz and ROPgadget";
    test -f $(which python)||ln -s $(which python3) /usr/sbin/python
    python -m pip install boofuzz ROPgadget
    return 0;
}

function setupService() {
    echo "$(date) setting up vulnerable service";
    test -f /opt/lab/lin-server||return 1;
    chmod +x /opt/lab/lin-server
    cat << EOF > /etc/systemd/system/lin-server.service
[Unit]
Description=Vulnerable Linux Server
After=network.target auditd.service sshd.service

[Service]
ExecStart=/opt/lab/lin-server
ExecReload=/opt/lab/lin-server
KillMode=process
Restart=always
RestartSec=3
[Install]
WantedBy=multi-user.target
Alias=vuln.service
EOF
  systemctl enable lin-server
  systemctl daemon-reload
  systemctl start lin-server
  return 0;
}

function removeService() {
    echo "$(date) removing vuln service";
    systemctl stop lin-server
    systemctl disable lin-server
    rm /etc/systemd/system/lin-server.service
    # rm -rf /opt/lab
    return 0;
}

function setupLearner() {
  echo "$(date) setting up learner environment";
  chmod +x /opt/lab/*
  for _file in /opt/lab/*.py; do
    ln -s "${_file}" /usr/sbin/$(basename "${_file}");
  done;
  for _file in /opt/lab/*.ps1; do
    ln -s "${_file}" /tmp/$(basename "${_file}");
  done;
  return 0;
}

function runSetup() {
    echo "$(date) setting up testing environment";
    test -f /tmp/.setup-complete && (echo "$(date) already setup environment" && exit 0);
    setupPackages || (echo "$(date) failed setup packages" && exit 1);
    setupService || (echo "$(date) failed setup services" && exit 1);
    setupLearner || (echo "$(date) failed setup services" && exit 1);
    touch /tmp/.setup-complete
    return 0
}
test -f /tmp/.setup-complete || runSetup;